<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login API Tester</title>
  </head>
  <body>
    <div>
      <input type="text" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button id="loginBtn">Login</button>
    </div>

    <div>
      <p>Token de acceso expirará en: <span id="countdown">--:--</span></p>
    </div>

    <div>
      <p>Token de refresco expirará en: <span id="countdown2">--:--</span></p>
    </div>

    <pre id="response">Aquí aparecerá la respuesta</pre>

    <div style="margin-bottom: 15px">
      <span>SOLICITAR NUEVO TOKEN DE ACCESO</span>
    </div>

    <button onclick="refreshAccessToken()">Solicitar token de refresco</button>

    <div style="margin-bottom: 15px; margin-top: 15px">
      <span>SUMA de dos números AUTORIZADA</span>
    </div>

    <div>
      <input type="number" id="num1" placeholder="Número1" />
      <input type="number" id="num2" placeholder="Número2" />
      <button onclick="sumar()">Sumar</button>
    </div>

    <div>
      <p>El resultado de la suma: <span id="suma"></span></p>
    </div>

    <script>
      const loginBtn = document.getElementById("loginBtn");
      const responseEl = document.getElementById("response");
      const countdownEl = document.getElementById("countdown");
      const countdownRefreshEl = document.getElementById("countdown2");

      let accessToken = null;
      let refreshToken = null;

      let countdownInterval = null;
      let refreshCountdownInterval = null;

      // =========================
      // Helpers
      // =========================
      function parseJwt(token) {
        try {
          const base64Payload = token.split(".")[1];
          return JSON.parse(atob(base64Payload));
        } catch {
          return null;
        }
      }

      function formatTime(seconds) {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
      }

      // =========================
      // Countdown ACCESS TOKEN
      // =========================
      function startAccessCountdown(exp) {
        if (countdownInterval) clearInterval(countdownInterval);

        let remaining = exp - Math.floor(Date.now() / 1000);

        countdownInterval = setInterval(() => {
          if (remaining <= 0) {
            clearInterval(countdownInterval);
            countdownEl.textContent = "Access expirado";
            return;
          }
          countdownEl.textContent = formatTime(remaining);
          remaining--;
        }, 1000);
      }

      // =========================
      // Countdown REFRESH TOKEN
      // =========================
      function startRefreshCountdown(exp) {
        if (refreshCountdownInterval) clearInterval(refreshCountdownInterval);

        let remaining = exp - Math.floor(Date.now() / 1000);

        refreshCountdownInterval = setInterval(() => {
          if (remaining <= 0) {
            clearInterval(refreshCountdownInterval);
            countdownRefreshEl.textContent = "Refresh expirado";
            return;
          }
          countdownRefreshEl.textContent = formatTime(remaining);
          remaining--;
        }, 1000);
      }

      // =========================
      // LOGIN
      // =========================
      loginBtn.addEventListener("click", async () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;

        try {
          const res = await fetch("http://localhost:5000/api/v1/auth/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password }),
              credentials: "include"

          });

          const data = await res.json();
          responseEl.textContent = JSON.stringify(data, null, 2);

          if (!res.ok) {
            alert(data.message);
            return;
          }

          accessToken = data.accessToken;
          refreshToken = data.refreshToken;

          sessionStorage.setItem("refreshToken", refreshToken);
          sessionStorage.setItem(
            "refreshTokenExpiresTime",
            data.refreshTokenExpiresTime
          );

          const payload = parseJwt(accessToken);
          if (payload?.exp) startAccessCountdown(payload.exp);

          if (data.refreshTokenExpiresTime)
            startRefreshCountdown(data.refreshTokenExpiresTime);

          alert("Login exitoso");
        } catch (err) {
          console.error(err);
          responseEl.textContent = "Error al conectar con la API";
        }
      });

      // =========================
      // REFRESH TOKEN
      // =========================

      async function refreshAccessToken() {
        const storedRefreshToken = sessionStorage.getItem("refreshToken");

        try {
          const response = await fetch(
            "http://localhost:5000/api/v1/auth/refresh",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-refresh-token": storedRefreshToken,
              },
            }
          );

          const data = await response.json();
          responseEl.textContent = JSON.stringify(data, null, 2);

          if (!response.ok) {
            console.error(data.message);
            return null;
          }

          accessToken = data.accessToken;
          refreshToken = data.refreshToken;

          sessionStorage.setItem("refreshToken", refreshToken);
          sessionStorage.setItem(
            "refreshTokenExpiresTime",
            data.refreshTokenExpiresTime
          );

          const payload = parseJwt(accessToken);
          if (payload?.exp) startAccessCountdown(payload.exp);

          if (data.refreshTokenExpiresTime)
            startRefreshCountdown(data.refreshTokenExpiresTime);

          return accessToken;
        } catch (error) {
          console.error("Error al refrescar token:", error);
          return null;
        }
      }
      async function sumar() {
        const num1 = Number(document.getElementById("num1").value);
        const num2 = Number(document.getElementById("num2").value);

        if (!accessToken) {
          accessToken = await refreshAccessToken(); // ✅ FIX
        }

        if (!accessToken) {
          document.getElementById("suma").innerText = "No autenticado";
          return;
        }

        try {
          const response = await fetch(
            "http://localhost:5000/api/v1/math/sumar",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${accessToken}`,
              },
              body: JSON.stringify({ num1, num2 }),
            }
          );

          const data = await response.json();

          if (!response.ok) {
            console.error(data.message);
            document.getElementById("suma").innerText = "Error";
            return;
          }

          document.getElementById("suma").innerText = data.resultado;
        } catch (error) {
          console.error(error);
          document.getElementById("suma").innerText = "Error";
        }
      }
    </script>
  </body>
</html>
